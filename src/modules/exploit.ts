import { Target } from '../../types/index';
import { logger } from '../utils';
import { ErrorLog } from '../../types/index';

export const attemptExploit = async (target: Target, key: string, successRate: number): Promise<boolean> => {
    // Clamp successRate between 0 and 1 for safety.
    const effectiveSuccessRate = Math.max(0, Math.min(1, successRate));

    logger.info(`Module [Exploit]: Attempting breach on ${target.ip} on ports [${target.ports.join(', ')}] with a ${Math.round(effectiveSuccessRate * 100)}% success chance...`);
    await new Promise(resolve => setTimeout(resolve, 500));
    
    // Mock logic with a dynamic success rate
    const success = Math.random() < effectiveSuccessRate;
    
    if (success) {
        logger.info(`Module [Exploit]: SUCCESS - Gained access to ${target.ip}.`);
    } else {
        logger.warn(`Module [Exploit]: FAILED - Could not breach ${target.ip}.`);
    }

    return success;
};

// Provides context for the last failed attempt
export const getLastError = (): Omit<ErrorLog, 'targetIp'> => {
    return { type: 'conn_fail', details: 'Port refused or firewall block.' };
};